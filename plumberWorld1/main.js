!function(){var t="updateCase",i="createCase",r="flashCase",e="destroyCase",s="isTutoGameMain",o="fillThisCaseWaitTimer",h="resetAllWaitTimer",a={top:{x:0,y:-1,r:"bottom"},right:{x:1,y:0,r:"left"},bottom:{x:0,y:1,r:"top"},left:{x:-1,y:0,r:"right"}},n=function(){};n.prototype.grid=[],n.prototype.gridInfo={},n.prototype.lastCaseTouched=!1,n.prototype.needChange=!1,n.prototype.lvl_info={},n.prototype.lvl_map=[],n.prototype.isInit=!1,n.prototype.ldMap,n.prototype.timeOutToClear=[],n.prototype.arrayPopRandom=[],n.prototype.init=function(t,i,r,e,s){if(!this.isInit){this.grid=[],this.lastCaseTouched=!1,this.gridInfo.GRID_WIDTH=t,this.lvl_map=this.ldMap[e-1]?this.ldMap[e-1]:this.ldMap[this.ldMap.length-1],this.gridInfo.GRID_HEIGHT=i,this.gridInfo.CASE_TYPE_NB=r,this.caseXStart=[3,4],this.gameMode=s,this.clearAllTimeout(),"story"!=this.gameMode&&(this.lvl_map=this.ldMap[g((this.ldMap.length-1)/2,this.ldMap.length-1)]),window.c={};for(var o=0;o<1e6;o++){var h=g((this.ldMap.length-1)/2,this.ldMap.length-1);window.c[h]||(window.c[h]=0),window.c[h]++}this.createGrid(t,i),this.fillGrid(r),this.isInit=!0}},n.prototype.setMap=function(t){this.ldMap=t},n.prototype.createGrid=function(t,i){for(var r=0;r<t;r++){this.grid.push([]);for(var e=0;e<i;e++)this.grid[r].push((new l).create(r,e,this))}},n.prototype.fillGrid=function(t){for(var i=0;i<this.grid.length;i++)for(var r=0;r<this.grid[i].length;r++)0==r?i!=this.caseXStart[0]&&i!=this.caseXStart[1]||(this.grid[i][r].type=6):this.grid[i][r].type=0,this.grid[i][r].updateExitDir();this.applyLD(),this.fillCase();for(i=0;i<this.grid.length;i++)for(r=0;r<this.grid[i].length;r++)this.grid[i][r].createC2()},n.prototype.applyLD=function(){var t,i=this.caseXStart[Math.floor(2*Math.random())];if(c2_callFunction(s))i=this.caseXStart[0];this.grid[i][0].isFilled=!0,this.grid[i][0].updateExitDir(),"story"!=this.gameMode&&(this.grid[this.caseXStart[0]][0].isFilled=!0,this.grid[this.caseXStart[0]][0].updateExitDir(),this.grid[this.caseXStart[1]][0].isFilled=!0,this.grid[this.caseXStart[1]][0].updateExitDir());for(var r=0;r<this.lvl_map.length;r++)t=this.lvl_map[r],this.grid[t.x][t.y].type=t.type,0==t.type&&(this.grid[t.x][t.y].type=Math.floor(Math.random()*this.gridInfo.CASE_TYPE_NB+1)),this.grid[t.x][t.y].updateExitDir(),this.grid[t.x][t.y].setRandomAngle(),void 0!==t.angle&&this.grid[t.x][t.y].setAngle(t.angle);if(!c2_callFunction(s)&&"story"==this.gameMode){this.createLd();for(var e=0;e<this.grid.length;e++)for(var o=0;o<this.grid[e].length;o++)this.grid[e][o].setRandomAngle()}this.startRandomPop()},n.prototype.updateAllCases=function(){for(var t=0;t<this.grid.length;t++)for(var i=0;i<this.grid[t].length;i++)this.grid[t][i].update()},n.prototype.turnCase=function(t,i){if(!(t>=this.gridInfo.GRID_WIDTH||t<0||i>=this.gridInfo.GRID_HEIGHT||i<0)){var r=this.grid[t][i];r.setAngle((r.angle+90)%360),this.fillCase()}},n.prototype.fillCase=function(){c2_callFunction(h);for(var t=0;t<this.grid.length;t++)for(var i=0;i<this.grid[t].length;i++)(0!=i||t!=this.caseXStart[0]&&t!=this.caseXStart[1])&&(this.grid[t][i]._lastFilled=this.grid[t][i].isFilled,this.grid[t][i]._indent=1e4,this.grid[t][i].filled(!1));this.grid[this.caseXStart[0]][0].isFilled&&this.fillNeightbor(!1,this.grid[this.caseXStart[0]][0],!0),this.grid[this.caseXStart[1]][0].isFilled&&this.fillNeightbor(!1,this.grid[this.caseXStart[1]][0],!0);for(t=0;t<this.grid.length;t++)for(i=0;i<this.grid[t].length;i++)(0!=i||t!=this.caseXStart[0]&&t!=this.caseXStart[1])&&(this.grid[t][i].isFilled||this.grid[t][i].update(),this.grid[t][i]._indent=1e4,this.grid[t][i].filled(!1));this.grid[this.caseXStart[0]][0].isFilled&&this.fillNeightbor(!0,this.grid[this.caseXStart[0]][0],!0),this.grid[this.caseXStart[1]][0].isFilled&&this.fillNeightbor(!0,this.grid[this.caseXStart[1]][0],!0)},n.prototype.fillNeightbor=function(t,i,r,e,s){var o=void 0===e?0:e;if(!i.isFilled||r||t&&!(o>=i._indent)){s=void 0===s?"top":s;var h=!1;for(var n in i.filled(!0),t&&(i.fillItInC2(o,s),i._lastFilled||o++,i._indent=o),a)i.exitDir[n]&&(h=this.getNeighbor(i,a[n].x,a[n].y))&&h.exitDir[a[n].r]&&this.fillNeightbor(t,h,!1,o,a[n].r)}},n.prototype.getNeighbor=function(t,i,r){if(!t)return!1;if(t.logicX+i>=this.gridInfo.GRID_WIDTH||t.logicY+r>=this.gridInfo.GRID_HEIGHT||t.logicX+i<0||t.logicY+r<0)return!1;var e=this.grid[t.logicX+i][t.logicY+r];return e||!1},n.prototype.isEnd=function(){if(!this.isInit)return 0;for(var t=0;t<this.grid.length;t++)for(var i=0;i<this.grid[t].length;i++)if(6!=this.grid[t][i].type&&0!=this.grid[t][i].type&&-1!=this.grid[t][i].type&&!this.grid[t][i].isFilled)return 0;return 1},n.prototype.createLd=function(){for(var t=this.grid[this.caseXStart[0]][0].isFilled?this.grid[this.caseXStart[0]][0]:this.grid[this.caseXStart[1]][0],i=0;i<this.grid.length;i++)for(var r=0;r<this.grid[i].length;r++)6!=this.grid[i][r].type&&0!=this.grid[i][r].type&&-1!=this.grid[i][r].type&&(this.grid[i][r].destroy(),this.grid[i][r].type=-111);this.createLdNextCase(t,0),this.fillVoidCase()},n.prototype.createLdNextCase=function(t){var i=[];for(var r in a){if(t.exitDir[r])(h=this.getNeighbor(t,a[r].x,a[r].y))&&h.exitDir[a[r].r]?h:h&&-111==h.type&&i.push({n:h,r:a[r].r})}Math.floor(Math.random()*i.length);for(var r in i=d(i)){var e=i[r].n,s=i[r].r;if(-111==e.type){var o=1;for(var r in a){var h;(h=this.getNeighbor(e,a[r].x,a[r].y))&&-111==h.type&&o++}var n=Math.max(2,o);e.type=Math.floor(Math.random()*n+1),1==o&&(e.type=5),e.updateExitDir(),e.setRandomAngle(),this.checkTypeCanBeHere(e,s),this.createLdNextCase(e)}else{if(e.exitDir[s])continue;t.removeExitDir(a[s].r)}}},n.prototype.turnInGoodDir=function(t,i){for(var r=0;r<4;r++){if(t.exitDir[i]&&this.checkIfExitDirIsPerfect(t,i))return!0;t.setAngle((t.angle+90)%360)}return!1},n.prototype.checkIfExitDirIsGood=function(t){for(var i in t.exitDir)if(t.exitDir[i]){var r=this.getNeighbor(t,a[i].x,a[i].y);if(!r)return!1;if(r&&!r.exitDir[a[i].r]&&-111!=r.type)return!1}return!0},n.prototype.checkIfExitDirIsPerfect=function(t,i){for(var r in t.exitDir)if(t.exitDir[r]&&r!=i){var e=this.getNeighbor(t,a[r].x,a[r].y);if(!e)return!1;if(!e.exitDir[a[r].r]||-111!=e.type)return!1}return!0},n.prototype.checkTypeCanBeHere=function(t,i){for(var r=0;!this.turnInGoodDir(t,i);)if(1==t.type&&(0==r?t.type+=2:t.type=6),r++,t.type-=1,t.updateExitDir(),t.setRandomAngle(),r>5){console.log("BIG PROBLEM: checkTypeCanBeHere",t);break}},n.prototype.fillVoidCase=function(){for(var t=[],i=[],r=[],e=0;e<this.grid.length;e++)for(var s=0;s<this.grid[e].length;s++)-111==this.grid[e][s].type&&t.push(this.grid[e][s]);for(t=d(t);t.length>0;){for(var o in i=[],t)if(r=[],-111==t[o].type){for(var h in a){(n=this.getNeighbor(t[o],a[h].x,a[h].y))&&n.type>0&&n.type<=5&&r.push({n:n,r:a[h].r})}var n;if(0==r.length)i.push(t[o]);else(n=r[Math.floor(Math.random()*r.length)]).n.addExitDir(n.r),this.createLdNextCase(n.n)}t=i}},n.prototype.destroyCaseFiled=function(t){for(var i=!1,r=[],e=0;e<this.grid.length;e++)for(var s=0;s<this.grid[e].length;s++)this.grid[e][s].isFilled&&-111!=this.grid[e][s].type&&0!=this.grid[e][s].type&&6!=this.grid[e][s].type&&-1!=this.grid[e][s].type&&(r.push(this.grid[e][s]),5==this.grid[e][s].type&&(i=!0));if(!i)return!1;this.timeOutToClear=[];for(var o=0;o<r.length;o++)r[o].isFilled=!1,r[o].destroy(),r[o].type=Math.floor(Math.random()*this.gridInfo.CASE_TYPE_NB+1),r[o].updateExitDir(),r[o].setRandomAngle(),this.timeOutToClear.push(setTimeout(r[o].createC2.bind(r[o]),1e3*(t+30*t/100)));this.timeOutToClear.push(setTimeout(this.fillCase.bind(this),1e3*(t+30*t/100)))},n.prototype.clearAllTimeout=function(){for(var t=0;t<this.timeOutToClear.length;t++)clearTimeout(this.timeOutToClear[t]);this.timeOutToClear=[]},n.prototype.maxPipeY=function(){for(var t=0,i=0;i<this.grid.length;i++)for(var r=0;r<this.grid[i].length;r++)-111!=this.grid[i][r].type&&0!=this.grid[i][r].type&&6!=this.grid[i][r].type&&-1!=this.grid[i][r].type&&(t=t>this.grid[i][r].logicY?t:this.grid[i][r].logicY);return t},n.prototype.startRandomPop=function(){this.arrayPopRandom=[];for(var t=0,i=0;i<this.grid.length;i++)for(var r=0;r<this.grid[i].length;r++)-111!=this.grid[i][r].type&&0!=this.grid[i][r].type&&6!=this.grid[i][r].type&&-1!=this.grid[i][r].type&&this.arrayPopRandom.push(t++)},n.prototype.getRandomPop=function(){return this.arrayPopRandom.splice(Math.floor(Math.random()*this.arrayPopRandom.length),1)[0]};var l=function(){};function d(t){for(var i,r,e=t.length;e;)r=Math.floor(Math.random()*e--),i=t[e],t[e]=t[r],t[r]=i;return t}function p(t,i){return t.right==i.right&&t.bottom==i.bottom&&t.left==i.left&&t.top==i.top}function g(t,i){return Math.floor(Math.random()*(i-t+1)+t)}l.id=0,l.prototype.create=function(t,i,r){return this.gameMain=r,this.id=l.id++,this.logicX=t,this.logicY=i,this.isFilled=!1,this.type=-1,this.angle=0,this.exitDir={top:0,bottom:0,left:0,right:0},this},l.prototype.getBaseExitDir=function(){var t=[0,0,1,1,1,0,0][this.type],i=[0,1,1,1,1,1,0][this.type];return{top:t,bottom:[0,0,0,0,1,0,1][this.type],left:[0,1,0,1,1,0,0][this.type],right:i}},l.prototype.updateExitDir=function(){if(!(this.type<0)){this.angle=0;var t=this.getBaseExitDir();for(var i in this.exitDir)this.exitDir[i]=t[i];6!=this.type||this.isFilled||(this.exitDir.bottom=0)}},l.prototype.setAngle=function(t){if(6!=this.type){var i=(t-this.angle)/90;i=i<0?i+4:i;for(var r=0;r<i;r++)this.turnIt();this.angle=t,this.update()}},l.prototype.setRandomAngle=function(){this.setAngle([0,90,180,270][Math.floor(4*Math.random())])},l.prototype.updateAngleByDir=function(){var t=this.getBaseExitDir();this.angle=0;for(var i=0;i<4&&(this.angle=(this.angle+90)%360,t=this.turnIt(!0,t),!p(this.exitDir,t));i++);},l.prototype.turnIt=function(t,i){t=void 0===t||t,i=void 0===i?this.exitDir:i;var r=JSON.parse(JSON.stringify(i)),e=JSON.parse(JSON.stringify(i));for(var s in r.top&&(e.right+=2),r.right&&(e.bottom+=2),r.bottom&&(e.left+=2),r.left&&(e.top+=2),e)e[s]=Math.max(0,Math.min(1,e[s]-1));if(t)for(var s in i)i[s]=e[s];return e},l.prototype.filled=function(t,i,r){this.isFilled,this.isFilled=t},l.prototype.fillItInC2=function(t,i){c2_callFunction(o,[this.logicX,this.logicY,t,i])},l.prototype.createC2=function(){c2_callFunction(i,[this.logicX,this.logicY,this.type,this.id,this.angle,this.isFilled?1:0])},l.prototype.flashCase=function(){c2_callFunction(r,[this.logicX,this.logicY])},l.prototype.update=function(){c2_callFunction(t,[this.logicX,this.logicY,this.type,this.id,this.angle,this.isFilled?1:0])},l.prototype.destroy=function(){this.type=0,this.updateExitDir(),this.destroyC2()},l.prototype.destroyC2=function(){c2_callFunction(e,[this.logicX,this.logicY])},l.prototype.removeExitDir=function(t){switch(this.exitDir[t]=0,this.type){case 1:case 2:this.type=5;break;case 3:this.exitDir.left&&this.exitDir.right||this.exitDir.top&&this.exitDir.bottom?this.type=1:this.type=2;break;case 4:this.type=3;break;default:console.log("PROBLEM de REMOVEDIR")}this.updateAngleByDir()},l.prototype.addExitDir=function(t){switch(this.exitDir[t]=1,this.type){case 1:case 2:this.type=3;break;case 3:this.type=4;break;case 5:this.exitDir.left&&this.exitDir.right||this.exitDir.top&&this.exitDir.bottom?this.type=1:this.type=2;break;default:console.log("PROBLEM de ADDDIR")}this.updateAngleByDir()},"object"!=typeof window.playtouch&&(window.playtouch={}),playtouch.gameMain=new n}();