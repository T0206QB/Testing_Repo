(function(){function e(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}}var t="c2:libJewel:",s=window.playtouchGame.match3.Pos;class i{constructor(){}createGrid(e,t,s,i=0){return this.grid=new r,this.grid.init(e,t,l),this.timeoutId=[],this.TIME_BETWEEN_DESTROY=s,this.TIME_BETWEEN_DESTROY_START=i,this}destroy(){for(var e=0;e<this.timeoutId.length;e++)clearTimeout(this.timeoutId[e]);delete this.grid,playtouch.seedsField.uproot("createItem_color")}clearTimeoutId(e){for(var t=0;t<this.timeoutId.length;t++)this.timeoutId[t]===e&&this.timeoutId.splice(t,1)}isTimeoutExist(){return Math.min(1,this.timeoutId.length)}createItem(e,t,s,i=!1){let r=this.grid.getCell(e,t);if(r.item){if(i)return this.destroyItem(e,t),this.createItem(...arguments);this.grid.applyOption(r.item,s),r.item.updated()}else this.grid.itemCreateOnPos(e,t,s)}loadLd(e,t){"string"==typeof e&&(e=JSON.parse(e)),this.ld=e,this.lvl=t,window.saveStateLvl||(window.saveStateLvl={}),window.saveStateLvl[t]={st:"ok",mp:void 0,pack:e.old.split("_")[0],lvl:e.old.split("_")[1]};var i="createItem_color";playtouch.seedsField.plant(i,t+(e.seed?"_"+e.seed:0)),window.saveStateLvl[t].seedValue=e.seed?e.seed:"";let r=[];for(let t=0;t<e.grid.length;t++)e.grid[t].spawnPoint&&r.push(new s(e.grid[t].x,e.grid[t].y));this.grid.rules.posCreateItem=[],this.grid.addRules("posCreateItem",[function(e,t,s,i){return e}.bind(void 0,r)]),this.grid.addRules("createItemOption",function(e,t){var s=0;return s=c2_callFunction("tuto_gameMain_isOnTuto",[],"match3:dev")?playtouch.seedsField.random(e):Math.random(),{color:Math.floor(s*t)}}.bind(void 0,i,e.nbColor)),this.currentLDColor=e.nbColor,this.grid.addRules("createItem",function(e,t,s,i,r){for(i.item=new s.itemClass(i,s,Math.floor(playtouch.seedsField.random(t)*e)),s.applyOption(i.item,r);s.checkMatch(!1,!1,!0).length>0;)i.item.color=Math.floor(playtouch.seedsField.random(t)*e);return i.item.create(),i.item}.bind(void 0,e.nbColor,i)),this.grid.ld_load(e.grid,e.nbColor);for(let e=0;e<r.length;e++)this.grid.getCell(r[e].x,r[e].y).isSpawn=!0;this.grid.addRules("createItem",function(e,t,s,i){s.item=new t.itemClass(s,t),t.applyOption(s.item,i);let r=c2_callFunction("cnd_totemLeftToCreate");if(s&&s.isSpawn&&r>0&&c2_callFunction("canCreateTotem")){let i=t.cells.filter(function(e){if(e.item&&"totem"==e.item.type)return e}).length;i<e&&i<r&&(s.item.type="totem")}return s.item.create(),s.item}.bind(void 0,this.grid.cells.filter(function(e){if(e.item&&"totem"==e.item.type)return e}).length)),this.grid.movePossible(!0)}add1ColorOnCreate(e=6){this.currentLDColor=Math.min(e,this.currentLDColor+1),this.grid.addRules("createItemOption",function(e){return{color:Math.floor(Math.random()*e)}}.bind(void 0,this.currentLDColor))}scoreDestroyBonus(){c2_callFunction("addScoreGlobal",[100])}destroyBombRadius(e,t,i,r=-1,l=-1,o=-1,a=!0,h){if(-1!==l){let e=this.grid.getCell(t,i),s=this.grid.getCell(r,l);e.item&&e.item.setType(""),s.item&&s.item.setType("")}let c=o,m=[];for(let t=-e;t<=e;t++)for(let i=-e;i<=e;i++)a&&Math.abs(i)==e&&Math.abs(t)==e||m.push(new s(t,i));let n=new s(t,i),d=this.grid.getCellByPos(n);if(d.item){let e=["totem","key","copyer","sinker","switcher","exploder","popper","blockLife","virus"];e.includes(d.item.type)||d.item.setType(""),-1==c&&(c=d.item.color)}this.destroyBombR(n,m,c,h)}destroyBombR(e,t,i,r="bonus_Bomb"){let l=[],o={match:[],name:r,color:i};for(let i=0;i<t.length;i++){let r=s.sumPos(e,t[i]),a=this.grid.getCellByPos(r),h=void 0,c=o;a&&(l.push(a),a.item&&"copyer"==a.item.type&&(c.match=[e],h=[this.grid.rulesClass.canDestroyItem_oneTime_cell,this.grid.rulesClass.canDestroyItem_life_copyer]),a.item&&"popper"==a.item.type&&(c.match=[e],h=[this.grid.rulesClass.canDestroyItem_life_popper_os,this.grid.rulesClass.canDestroyItem_oneTime_cell,this.grid.rulesClass.canDestroyItem_life]),this.destroyItemByTimeout(this.grid.checkRules.checkDestroyItem.bind(this.grid.checkRules,a,this.grid,c,h,void 0,"bonus"),e,a.pos))}this.check_coat([e],l)}destroyLineCross(e,t,s,i){let r=this.grid.getCell(e,t),l=this.grid.getCell(s,i);r.item&&r.item.setType(""),l.item&&l.item.setType(""),this.destroyLineVertical(e,t),this.destroyLineHorizontal(e,t)}destroyLineVertical(e,t,i=1,r=-1,l=-1,o=-1){if(-1!==l){let s=this.grid.getCell(e,t),i=this.grid.getCell(r,l);s.item&&s.item.setType(""),i.item&&i.item.setType("")}for(var a=0;a<i;a++){let r=[],l=e-Math.floor(i/2)+a;for(let e=0;e<this.grid.cells.length;e++)this.grid.cells[e].x==l&&r.push(this.grid.cells[e]);this.destroyLine(new s(e,t),r,o)}}destroyLineHorizontal(e,t,i=1,r=-1,l=-1,o=-1){if(-1!==l){let s=this.grid.getCell(e,t),i=this.grid.getCell(r,l);s.item&&s.item.setType(""),i.item&&i.item.setType("")}for(var a=0;a<i;a++){let r=[],l=t-Math.floor(i/2)+a;for(let e=0;e<this.grid.cells.length;e++)this.grid.cells[e].y==l&&r.push(this.grid.cells[e]);this.destroyLine(new s(e,t),r,o)}}destroyLine(e,t,i=-1){let r=[],l=[];for(let e=0;e<t.length;e++)t[e].item&&"sinker"==t[e].item.type&&r.push(t[e]);let o=this.grid.getCellByPos(e),a=i;o&&o.item&&-1==a&&(a=o.item.color);for(var h=0;h<t.length;h++){let i=t[h],o=!0;for(var c=0;c<r.length;c++){if(s.equal(i.pos,r[c].pos))continue;if(i.pos.x!=r[c].pos.x&&i.pos.y!=r[c].pos.y)continue;let t=s.distPos(e,r[c].pos),l=s.distPos(e,i.pos);if((t>0&&l>0||t<0&&l<0)&&Math.abs(l)>Math.abs(t)){o=!1;break}}if(!o)continue;l.push(i);let m=void 0;i.item&&"copyer"==i.item.type&&(m=[this.grid.rulesClass.canDestroyItem_life_copyer]),this.destroyItemByTimeout(this.grid.checkRules.checkDestroyItem.bind(this.grid.checkRules,i,this.grid,{match:[e],name:"bonus_line",color:a},m,void 0,"bonus"),e,i.pos)}this.check_coat([e],l)}destroyColorBomb(e,t,i,r=""){let l=[],o=0,a=this.grid.grid[e][t];a.item&&l.push(a);for(let e=0;e<this.grid.cellsSortTop.length;e++){let t=this.grid.cellsSortTop[e];t.item&&("colorBomb"!==t.item.type&&"blockLife"!==t.item.type&&"chest"!==t.type&&t.item.color===i&&(""!==r&&""===t.item.type&&t.item.setType(r,!1),l.push(t)))}for(let e=0;e<l.length;e++)l[e].item&&(this.destroyItemByTimeout(this.grid.checkRules.checkDestroyItem.bind(this.grid.checkRules,l[e],this.grid,void 0,void 0,void 0,"bonus_colorBomb"),new s(0,0),l[e].pos,o/2),o++);this.check_coat([new s(e,t)],l)}destroyColorBomb_all(e,t){let i=0,r=[];for(let e=0;e<this.grid.cellsSortTop.length;e++){let t=this.grid.cellsSortTop[e];t.item&&(this.destroyItemByTimeout(this.grid.checkRules.checkDestroyItem.bind(this.grid.checkRules,t,this.grid,void 0,void 0,void 0,"bonus_colorBomb"),new s(0,0),t.pos,i/10),r.push(t),i++)}this.check_coat([new s(e,t)],r)}destroyTotem(e,t){let s=this.grid.getCell(e,t);return!!s.item&&("totem"==s.item.type&&(!("blockLife"==s.type&&s.life>0)&&(!("chest"==s.type&&s.life>0)&&this.grid.checkRules.checkDestroyItem(s,this.grid,void 0,[this.grid.rulesClass.canDestroyItem_all],[]))))}destroyItem(e,t,s=""){let i=this.grid.grid[e][t];i.item&&this.grid.checkRules.checkDestroyItem(i,this.grid,void 0,void 0,void 0,s)}destroyKey(){let e=!1;for(let t=0;t<this.grid.cells.length;t++)"chest"==this.grid.cells[t].type&&(this.grid.cells[t].life--,this.grid.cells[t].life<=0&&(this.grid.cells[t].setType(""),e=!0),this.grid.cells[t].updated());e&&this.grid.checkMatch(!0)}destroyItemByTimeout(e,t,i,r){var l=playtouch.arrayWaitForFunction.waitForFunctionJS(this.TIME_BETWEEN_DESTROY_START+(void 0===r?Math.abs(s.distPos(t,i)):r)*this.TIME_BETWEEN_DESTROY,()=>{this.clearTimeoutId(l),e()});this.timeoutId.push(l)}setItemType(e,t,s=""){let i=this.grid.getCell(e,t);i.item&&i.item.setType(s)}addStarterItem(e,i){let r=[],l={used:0,type:e};for(let e=0;e<this.grid.cellsSortTop.length;e++){let t=this.grid.cellsSortTop[e];"bgLife"!==t.type&&"coat"!==t.type&&""!==t.type||t.item&&""===t.item.type&&(playtouchGame.main.ld.grid.find(e=>e.items&&s.equal(t.pos,new s(e.x,e.y)))||r.push(t))}if(r.length<=0)return JSON.stringify(l);let o=r[Math.floor(Math.random()*r.length)],a={type:e};return void 0!==i&&(a.color=i),window.eventToFire.fireEvent(t+"itemStarter",this.grid.getCell(o.x,o.y).item.uid),this.createItem(o.x,o.y,a),l.color=this.grid.getCell(o.x,o.y).item.color,l.used=1,l.x=o.x,l.y=o.y,JSON.stringify(l)}addVirus(){let e=[new s(0,1),new s(1,0),new s(0,-1),new s(-1,0)],t=[],i=["line_h","line_v","bomb","colorBomb"];for(let r=0;r<this.grid.cells.length;r++){let l=this.grid.cells[r];if(l.item&&"virus"==l.item.type)for(let r=0;r<e.length;r++){let o=this.grid.getCellByPos(s.sumPos(l.pos,e[r]));o&&(""!=o.type&&"coat"!=o.type||(o.item?(""===o.item.type||i.includes(o.item.type))&&t.push(o):t.push(o)))}}if(t.length<=0)return!1;let r=t[Math.floor(Math.random()*t.length)];return r.item?!(""!==r.item.type&&!i.includes(r.item.type))&&(r.setType(""),r.item.setType("virus"),!0):(r.setType(""),this.grid.itemCreateOnCell(r,{type:"virus"}),!0)}victory_destroyAllBonus(){let e=["line","line_h","line_v","bomb","colorBomb"],t=["blockLife","chest"],s=!1;for(let i=0;i<this.grid.cells.length;i++){let r=this.grid.cells[i];r.item&&(t.includes(r.type)||e.includes(r.item.type)&&(this.destroyItem(r.x,r.y,"victory"),s=!0))}return s}victory_createBonusLine(t){let s=!1,i=[],r=["blockLife","chest"];for(let e=0;e<this.grid.cells.length;e++){let t=this.grid.cells[e];t.item&&(""!=!t.item.type&&(r.includes(t.type)||(i.push(t.item),s=!0)))}e(i);for(var l=0;l<t&&!(l>=i.length);l++)this.createItem(i[l].x,i[l].y,{type:Math.random()>.5?"line_v":"line_h"});return s}exploder_addTurn(e){for(let t=0;t<this.grid.cells.length;t++){let s=this.grid.cells[t];s.item&&("exploder"==s.item.type&&(s.item.timer=Math.max(e,s.item.timer+e)))}}check_coat_fromC2Match(e={match:[]}){"string"==typeof e&&(e=JSON.parse(e));let t=[];for(var i=0;i<e.match.length;i++)t.push(new s(e.match[i].x,e.match[i].y));this.check_coat(t)}check_coat(e=[],t=[],s=!1){if(e.length<=0)return!1;let i=!1;for(let t=0;t<e.length;t++)(e[t].pos||(e[t]=this.grid.getCellByPos(e[t]),e[t]))&&"coat"==e[t].type&&(i=!0);if(!i)return!1;for(let e=0;e<t.length;e++)t[e].pos||(t[e]=this.grid.getCellByPos(t[e]));t.push(...e);for(let e=0;e<t.length;e++)t[e].item&&"popper"!=t[e].item.type&&"copyer"!=t[e].item.type&&"blockLife"!=t[e].item.type&&(""!=t[e].type&&"totem"!=t[e].type||t[e].setType("coat"))}createOnMatch(e,t){"string"==typeof e&&(e=JSON.parse(e));let i,r=!1;e.match.unshift(new s(e.posCreate.x,e.posCreate.y));for(var l=0;l<e.match.length&&(0!=l&&e.match[l].x==e.posCreate.x&&e.match[l].y==e.posCreate.y||(i=this.grid.getCellByPos(e.match[l]),!i||(i.item?""==i.item.type&&(r=!0):r=!0,!r)));l++);if(r){let s={type:"",color:t};switch(e.name){case"match_4":s.type=["line_v","line_h"][Math.round(Math.random())];break;case"match_4_v":s.type="line_v";break;case"match_4_h":s.type="line_h";break;case"match_T7":case"match_5":case"match_Cross9":case"match_Cross8":case"match_Cross7":case"match_Cross7_2":s.type="colorBomb";break;case"match_T5":case"match_T6":case"match_L4":case"match_L5":case"match_Cross6":case"match_Cross5":s.type="bomb"}""!=s.type&&this.createItem(i.x,i.y,s)}}resetPopper(e,t){let s=this.grid.getCell(e,t);if(!s)return;let i=s.item;i&&"popper"==i.type&&(i.baseLife||(i.baseLife=i.life),i.life=i.baseLife,i.updated())}forceUpdateItem(e,t){let s=this.grid.getCell(e,t);s.item&&s.item.updated()}}class r extends window.playtouchGame.match3.Grid{constructor(){super()}init(){return super.init(...arguments),this.addRules("match",[this.rulesClass.match_Cross9,this.rulesClass.match_Cross8,this.rulesClass.match_Cross7,this.rulesClass.match_Cross7_2,this.rulesClass.match_T7,this.rulesClass.match_5,this.rulesClass.match_Cross6,this.rulesClass.match_Cross5,this.rulesClass.match_T6,this.rulesClass.match_T5,this.rulesClass.match_L5,this.rulesClass.match_4,this.rulesClass.match_3]),this.addRules("matchItems",[this.rulesClass.matchItems_type_popper,this.rulesClass.matchItems_cell_type_chest,this.rulesClass.matchItems_type_sinker,this.rulesClass.matchItems_type_copyer,this.rulesClass.matchItems_type_virus,this.rulesClass.matchItems_type_blockLife,this.rulesClass.matchItems_type_colorBomb,this.rulesClass.matchItems_type_totem,this.rulesClass.matchItems_color,this.rulesClass.matchItems_all]),this.addRules("swapItems",[this.rulesClass.swapItems_near1Cell,this.rulesClass.swapItems_noSwap,this.rulesClass.swapItems_blockLife]),this.addRules("swapItemsMatch",[this.rulesClass.swapItems_bonus,this.rulesClass.swapItems_match]),this.addRules("sortCells",this.rulesClass.sortCells_bottom),this.addRules("move",[this.rulesClass.move_bottom_1,this.rulesClass.move_bottomLeftRight_nearBorder_1,this.rulesClass.move_bottomLeftRight_1]),this.addRules("canMove",[this.rulesClass.canMove_type_noMove,this.rulesClass.canMove_type_blockLife,this.rulesClass.canMove_type_void,this.rulesClass.canMove_empty]),this.addRules("canCreateItem",[this.rulesClass.canCreateItem_void]),this.addRules("canDestroyNoItem",[this.rulesClass.canDestroyItem_oneTime_cell_rulesNoItem,this.rulesClass.canDestroyItem_cellBGLife]),this.addRules("canDestroyItem",[this.rulesClass.canDestroyItem_oneTime_cell,this.rulesClass.canDestroyItem_cellChest,this.rulesClass.canDestroyItem_cellBlockLife,this.rulesClass.canDestroyItem_totem,this.rulesClass.canDestroyItem_popperNearDestroyed,this.rulesClass.canDestroyItem_virusNearDestroyed,this.rulesClass.canDestroyItem_blockLifeNearDestroyed,this.rulesClass.canDestroyItem_sinkerNearDestroyed,this.rulesClass.canDestroyItem_copyerNearDestroyed,this.rulesClass.canDestroyItem_life,this.rulesClass.canDestroyItem_all]),this.addRules("createItem",this.rulesClass.createItemDefault_type_random4),this.addRules("canTouch",[this.rulesClass.canTouch_type_item_popper,this.rulesClass.canTouch_type_item_copyer,this.rulesClass.canTouch_type_cell_chest]),this}}class l extends window.playtouchGame.match3.Cell{constructor(){super(...arguments)}}class o{constructor(){this.timerMatch={}}sortPosWall(e){e=Object.values(e);for(var t=[e.splice(0,1)[0]];e.length>0;){for(var s=!1,i=0;i<e.length;i++){var r=t[t.length-1];if(r.destX==e[i].startX&&r.destY==e[i].startY){t.push(e.splice(i,1)[0]),s=!0;break}var l=t[0];if(l.destX==e[i].startX&&l.destY==e[i].startY){t.unshift(e.splice(i,1)[0]),s=!0;break}if(r=t[t.length-1],r.destX==e[i].destX&&r.destY==e[i].destY){let r=e.splice(i,1)[0];t.push({startX:r.destX,startY:r.destY,destX:r.startX,destY:r.startY}),s=!0;break}if(l=t[0],l.startX==e[i].startX&&l.startY==e[i].startY){let r=e.splice(i,1)[0];t.unshift({startX:r.destX,startY:r.destY,destX:r.startX,destY:r.startY}),s=!0;break}}s||t.push(e.splice(0,1)[0])}return JSON.stringify(t)}getBezierXY(e,t,s,i,r,l,o,a,h,c){switch(e){case"x":return Math.pow(1-t,3)*s+3*t*Math.pow(1-t,2)*r+3*t*t*(1-t)*o+t*t*t*h;case"y":return Math.pow(1-t,3)*i+3*t*Math.pow(1-t,2)*l+3*t*t*(1-t)*a+t*t*t*c}}startTime(e="default"){this.timerMatch[e]||(this.timerMatch[e]={lastTime:-1,arr:[],countZero:0}),this.timerMatch[e].lastTime=window.performance.now()}endTime(e="default"){if(!this.timerMatch[e])return;let t=window.performance.now()-this.timerMatch[e].lastTime;t<=0?this.timerMatch[e].countZero++:(this.timerMatch[e].arr.push(t),this.timerMatch[e].average=this.getTimeAverage(e),this.timerMatch[e].allTime=this.getAllTime(e),this.timerMatch[e].sum=this.sumAllTime(e))}getTimeAverage(e="default"){return this.timerMatch[e]?this.timerMatch[e].arr.length<=0?0:Math.round(this.timerMatch[e].arr.reduce((e,t)=>e+t)/this.timerMatch[e].arr.length*100)/100:0}getAllTime(e="default"){if(!this.timerMatch[e])return 0;if(this.timerMatch[e].arr.length<=0)return 0;let t=this.timerMatch[e].arr.sort((e,t)=>t-e);return Math.round(100*t[t.length-1])/100+">"+this.getTimeAverage(e)+"<"+Math.round(100*t[0])/100}resetAllTime(e="default"){this.timerMatch[e]&&(this.timerMatch[e].arr=[])}sumAllTime(e="default"){return this.timerMatch[e]?this.timerMatch[e].arr.length<=0?0:this.timerMatch[e].arr.reduce((e,t)=>e+t,0):0}decompressString(e,t){let s="|";var i,r=e.split(s);switch((1===r.length||r[0].length>16)&&r.unshift("plain"),i=r.shift(),e=r.join(s),void 0===t&&(t=i),t){case"lz_Base64":e=LZUTF8.decompress(e,{inputEncoding:t.split("_")[1]})}let l={width:"w",height:"h",cells:"c",option:"o",life:"l",starValues:"S",nbColor:"n",grid:"g",type:"t",void:"v",items:"i",color:"C",spawnPoint:"s",value:"V",bgLife:"b",blockLife:"B",sinker:"si",key:"k",totem:"to",exploder:"e",switcher:"sw",virus:"vi",chest:"ch",copyer:"Co",popper:"p",cndLose:"cl",cndWin:"cw",cndType:"ct",turns:"T"};for(let t in l){let s=new RegExp('"'+l[t]+'"',"g");e=e.replace(s,'"'+t+'"')}return e}getLastNotifByName(e,t){e="string"==typeof e?JSON.parse(e):e;var s={name:"",timeEnd:-1};for(var i in e)"active"==e[i].state&&-1!=e[i].name.indexOf(t)&&e[i].timeEnd>s.timeEnd&&(s.name=e[i].name,s.timeEnd=e[i].timeEnd);return s.name}}void 0===window.playtouchGame&&(window.playtouchGame={}),void 0===window.playtouchGame.match3&&(window.playtouchGame.match3={}),window.playtouchGame.main=new i,window.playtouchGame.utils=new o})();